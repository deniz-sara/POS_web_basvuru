<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS BaÅŸvurusu | Firma AdÄ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="form-header">
                <img src="qnbpay-logo.webp" alt="QNB Logo"
                    style="height: 40px; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">
                <h1>Fiziki POS BaÅŸvurusu</h1>
                <p>BaÅŸvurunuzu tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± takip edin.</p>
                <div style="margin-top: 15px;">
                    <a href="sorgula.html" class="btn btn-prev"
                        style="text-decoration: none; font-size: 13px; padding: 8px 16px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        ğŸ” BaÅŸvuru Durumu Sorgula
                    </a>
                </div>
            </div>

            <!-- Stepper -->
            <div class="stepper">
                <div class="step active" id="step-1-indicator">
                    <div class="step-circle">1</div>
                    <div class="step-label">Firma Bilgileri</div>
                </div>
                <div class="step" id="step-2-indicator">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ä°letiÅŸim</div>
                </div>
                <div class="step" id="step-3-indicator">
                    <div class="step-circle">3</div>
                    <div class="step-label">POS Talep</div>
                </div>
                <div class="step" id="step-4-indicator">
                    <div class="step-circle">4</div>
                    <div class="step-label">Evrak YÃ¼kleme</div>
                </div>
            </div>

            <form id="posForm">
                <!-- STEP 1: Firma Bilgileri -->
                <div class="step-content active" id="step-1">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Firma Tam AdÄ± <span class="required">*</span></label>
                            <input type="text" name="firma_unvani" required placeholder="Firma Tam AdÄ±">
                        </div>
                        <div class="form-group">
                            <label>Tabela AdÄ± / Slip BaÅŸlÄ±ÄŸÄ±</label>
                            <input type="text" name="tabela_adi" maxlength="20" placeholder="Max 20 Karakter">
                        </div>
                        <div class="form-group">
                            <label>Åirket Tipi <span class="required">*</span></label>
                            <select name="sirket_tipi" required>
                                <option value="">SeÃ§iniz...</option>
                                <option value="Sahis">ÅahÄ±s</option>
                                <option value="Tuzel">TÃ¼zel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vergi No <span class="required">*</span></label>
                            <input type="text" name="vergi_no" required maxlength="10" minlength="10" pattern="\d{10}"
                                title="Vergi No tam 10 haneli rakam olmalÄ±dÄ±r."
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                placeholder="10 Haneli Vergi No">
                        </div>
                        <div class="form-group">
                            <label>TC Kimlik No <span class="required">*</span></label>
                            <input type="text" name="tc_no" required maxlength="11" minlength="11" pattern="\d{11}"
                                title="TC Kimlik No tam 11 haneli rakam olmalÄ±dÄ±r."
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                placeholder="11 Haneli TC Kimlik No">
                        </div>
                        <div class="form-group">
                            <label>Vergi Dairesi <span class="required">*</span></label>
                            <input type="text" name="vergi_dairesi" required placeholder="BaÄŸlÄ± Olunan Vergi Dairesi">
                        </div>
                        <div class="form-group">
                            <label>Faaliyet AlanÄ± <span class="required">*</span></label>
                            <select name="faaliyet_alani" required>
                                <option value="">SeÃ§iniz...</option>
                                <option value="Market ve Bakkallar">Market ve Bakkallar</option>
                                <option value="Giyim ve Tekstil">Giyim ve Tekstil</option>
                                <option value="Yeme-Ä°Ã§me (Restoran/Kafe)">Yeme-Ä°Ã§me (Restoran/Kafe)</option>
                                <option value="E-Ticaret ve Online SatÄ±ÅŸ">E-Ticaret ve Online SatÄ±ÅŸ</option>
                                <option value="Kozmetik ve GÃ¼zellik">Kozmetik ve GÃ¼zellik</option>
                                <option value="Mobilya ve Dekorasyon">Mobilya ve Dekorasyon</option>
                                <option value="Otomotiv ve Yedek ParÃ§a">Otomotiv ve Yedek ParÃ§a</option>
                                <option value="Turizm ve Seyahat">Turizm ve Seyahat</option>
                                <option value="EÄŸitim ve DanÄ±ÅŸmanlÄ±k">EÄŸitim ve DanÄ±ÅŸmanlÄ±k</option>
                                <option value="SaÄŸlÄ±k Hizmetleri / Medikal">SaÄŸlÄ±k Hizmetleri / Medikal</option>
                                <option value="Eczaneler">Eczaneler</option>
                                <option value="KÄ±rtasiye ve Kitapevi">KÄ±rtasiye ve Kitapevi</option>
                                <option value="Toptan Ticaret">Toptan Ticaret</option>
                                <option value="Ä°nÅŸaat ve YapÄ± Malzemeleri">Ä°nÅŸaat ve YapÄ± Malzemeleri</option>
                                <option value="Etkinlik ve Organizasyon">Etkinlik ve Organizasyon</option>
                                <option value="DiÄŸer (Hizmet/Ãœretim)">DiÄŸer (Hizmet/Ãœretim)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ä°l <span class="required">*</span></label>
                            <select name="il" id="ilSelect" required>
                                <option value="">Ä°l SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ä°lÃ§e <span class="required">*</span></label>
                            <select name="ilce" id="ilceSelect" required disabled>
                                <option value="">Ã–nce Ä°l SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Tam Adres <span class="required">*</span></label>
                            <textarea name="adres" required rows="3" placeholder="Firma AÃ§Ä±k Adresi"></textarea>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Ä°letiÅŸim Bilgileri -->
                <div class="step-content" id="step-2">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Yetkili AdÄ± SoyadÄ± <span class="required">*</span></label>
                            <input type="text" name="yetkili_ad_soyad" required placeholder="Ad Soyad">
                        </div>
                        <div class="form-group">
                            <label>Cep Telefonu <span class="required">*</span></label>
                            <input type="tel" name="telefon" required placeholder="05XXXXXXXXX" maxlength="11"
                                minlength="11" pattern="^05[0-9]{9}$"
                                title="05 ile baÅŸlayan 11 haneli geÃ§erli bir telefon numarasÄ± giriniz (Ã–rn: 05321234567)"
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>
                        <div class="form-group">
                            <label>E-posta Adresi <span class="required">*</span></label>
                            <input type="email" name="email" required pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}$"
                                title="GeÃ§erli bir e-posta adresi giriniz" placeholder="ornek@firma.com">
                        </div>
                        <div class="form-group full-width">
                            <label>Alternatif Telefon</label>
                            <input type="tel" name="alt_telefon" placeholder="Ä°steÄŸe BaÄŸlÄ±">
                        </div>
                    </div>
                </div>

                <!-- STEP 3: POS Talep -->
                <div class="step-content" id="step-3">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Cihaz MÃ¼lkiyeti <span class="required">*</span></label>
                            <select name="cihaz_mulkiyeti" id="cihaz_mulkiyeti" required
                                onchange="renderCihazFormlari()">
                                <option value="">SeÃ§iniz...</option>
                                <option value="QNBpay">QNBpay'den Yeni Cihaz Talep Ediyorum</option>
                                <option value="Kendi Cihazim">Kendi CihazÄ±mÄ± KullanacaÄŸÄ±m</option>
                            </select>
                            <div id="kendiCihazimUyari"
                                style="display: none; margin-top: 8px; font-size: 13px; color: var(--error); background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca;">
                                <strong>Ã–nemli UyarÄ±:</strong> Mevcut cihazÄ±nÄ±zla Ã§alÄ±ÅŸmak istemeniz durumunda; yalnÄ±zca
                                <strong>Pavo ve Hugin</strong> marka cihazlarla entegrasyonumuz bulunmaktadÄ±r.
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Talep Edilen / Mevcut POS Adedi <span class="required">*</span></label>
                            <input type="number" name="pos_adedi" id="pos_adedi" required min="1" max="50" value="1"
                                oninput="renderCihazFormlari()">
                        </div>
                        <div class="form-group">
                            <label>POS Tipi <span class="required">*</span></label>
                            <select name="pos_tipi" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="MasaÃ¼stÃ¼">MasaÃ¼stÃ¼ (Kablolu)</option>
                                <option value="Mobil">Mobil (Seyyar)</option>
                                <option value="Yazarkasa">Yazarkasa POS / Ã–KC</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dynamic Cihaz DetaylarÄ± Container -->
                    <div id="cihazlarContainer" style="margin-top: 25px;"></div>
                </div>
                <div class="form-group">
                    <label>Tahmini AylÄ±k Ciro (TL) <span class="required">*</span></label>
                    <input type="text" name="aylik_ciro" required placeholder="10,000" oninput="formatCurrency(this)">
                </div>
        </div>
    </div>

    <!-- STEP 4: Evraklar -->
    <div class="step-content" id="step-4">
        <p style="margin-bottom: 20px; color: var(--text-light); font-size: 14px;">
            LÃ¼tfen baÅŸvuru iÃ§in gerekli evraklarÄ± PDF, JPG veya PNG formatÄ±nda (Maks 15MB) yÃ¼kleyiniz.
            Zorunlu evraklarÄ± yÃ¼klemeden baÅŸvuruyu tamamlayamazsÄ±nÄ±z.
        </p>

        <div class="file-upload-grid" id="fileGrid">
            <!-- JS TarafÄ±ndan Doldurulacak -->
        </div>

        <div style="margin-top: 30px;">
            <div class="checkbox-group">
                <input type="checkbox" id="kvkk" required>
                <label for="kvkk">KVKK AydÄ±nlatma Metni'ni okudum ve kabul ediyorum. <span
                        class="required">*</span></label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="onay" required>
                <label for="onay">VerdiÄŸim bilgilerin doÄŸruluÄŸunu ve baÅŸvuru koÅŸullarÄ±nÄ± kabul ediyorum.
                    <span class="required">*</span></label>
            </div>
        </div>
    </div>

    <!-- Success Screen -->
    <div class="step-content success-state" id="step-5">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
        </svg>
        <h2>BaÅŸvurunuz AlÄ±ndÄ±!</h2>
        <p>Referans NumaranÄ±z: <strong id="successBasvuruNo">---</strong>
            <button type="button" onclick="copyBasvuruNo()"
                style="margin-left: 10px; cursor: pointer; border: none; background: var(--primary); color: white; border-radius: 4px; padding: 4px 8px; font-size: 12px;">Kopyala</button>
        </p>
        <p style="font-size: 14px; color: var(--text-light);">BaÅŸvurunuz alÄ±nmÄ±ÅŸ olup deÄŸerlendirme sÃ¼recine
            geÃ§ilmiÅŸtir. Durumu takip etmeniz iÃ§in detaylar e-posta ve SMS olarak gÃ¶nderilmiÅŸtir.</p>
        <div style="margin-top: 30px;">
            <a href="/pos/sorgula.html" id="trackLink" class="btn btn-next">BaÅŸvuru Durumu Sorgula</a>
        </div>
    </div>

    <!-- Buttons -->
    <div class="btn-group" id="btnGroup">
        <button type="button" class="btn btn-prev hidden" id="prevBtn" onclick="nextPrev(-1)">Geri</button>
        <div style="flex:1"></div>
        <button type="button" class="btn btn-next" id="nextBtn" onclick="nextPrev(1)">Ä°leri</button>
        <button type="button" class="btn btn-submit hidden" id="submitBtn" onclick="submitForm()">BaÅŸvuruyu
            GÃ¶nder</button>
    </div>
    </form>
    </div>
    </div>

    <script src="iller.js"></script>
    <script>
        const belgeler = [
            { id: 'ticari_sicil', mask: 'Ticari Sicil Gazetesi', required: true, desc: 'GÃ¼ncel tarihli' },
            { id: 'imza_sirkuleri', mask: 'Ä°mza SirkÃ¼leri', required: true, desc: 'Noter onaylÄ±' },
            { id: 'vergi_levhasi', mask: 'Vergi LevhasÄ±', required: true, desc: 'Son yÄ±la ait' },
            { id: 'kimlik_fotokopisi', mask: 'Kimlik Fotokopisi', required: true, desc: 'Yetkilinin Ã¶n yÃ¼zÃ¼' },
            { id: 'faaliyet_belgesi', mask: 'Faaliyet Belgesi', required: true, desc: 'Oda kayÄ±t belgesi' },
            { id: 'gmu_muafiyet', mask: 'GMU ve Muafiyet Belgesi', required: false, desc: 'Ä°steÄŸe baÄŸlÄ±' },
            { id: 'kira_tapu', mask: 'QNBpay SÃ¶zleÅŸme', required: true, desc: 'Zorunlu Ä°mzalÄ± SÃ¶zleÅŸme' },
            { id: 'banka_hesabi', mask: 'Banka Hesap CÃ¼zdanÄ±', required: true, desc: 'Zorunlu Ä°mza Sirk.' }
        ];

        let currentTab = 0;
        let filesData = {};

        function init() {
            renderFileGrid();
            initSehirler();
            showTab(currentTab);
        }

        function renderCihazFormlari() {
            const mulkiyet = document.getElementById('cihaz_mulkiyeti').value;
            const adet = parseInt(document.getElementById('pos_adedi').value) || 0;
            const container = document.getElementById('cihazlarContainer');
            const uyari = document.getElementById('kendiCihazimUyari');

            if (mulkiyet === 'Kendi Cihazim') {
                uyari.style.display = 'block';
            } else {
                uyari.style.display = 'none';
            }

            container.innerHTML = '';
            if (adet <= 0 || !mulkiyet) return;

            // Global adres kopyalama aracÄ±
            let toolsHtml = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--primary);">HÄ±zlÄ± Adres Doldurma</div>
                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="copyCenterAddress" onchange="copyAddressFromStep1(this)">
                        <label for="copyCenterAddress" style="font-size: 13px;">KullanÄ±m adresi Firma Merkez Adresi (1. AdÄ±m) ile aynÄ±dÄ±r.</label>
                    </div>
            `;
            if (adet > 1) {
                toolsHtml += `
                    <div class="checkbox-group">
                        <input type="checkbox" id="copyAllFromFirst" onchange="copyFirstDeviceAddressToAll(this)">
                        <label for="copyAllFromFirst" style="font-size: 13px;">TÃ¼m cihazlar 1. Cihaz ile aynÄ± adreste kullanÄ±lacaktÄ±r.</label>
                    </div>
                `;
            }
            toolsHtml += `</div>`;
            container.innerHTML += toolsHtml;

            // Dinamik Cihaz KutularÄ±
            for (let i = 1; i <= adet; i++) {
                const isSeriRequired = mulkiyet === 'Kendi Cihazim' ? 'required' : '';
                const seriHtml = mulkiyet === 'Kendi Cihazim'
                    ? `<div class="form-group full-width">
                           <label>Cihaz ${i} Seri No <span class="required">*</span></label>
                           <input type="text" name="cihaz_${i}_seri" required placeholder="CihazÄ±n arkasÄ±ndaki S/N numarasÄ±">
                       </div>`
                    : '';

                container.innerHTML += `
                    <div class="cihaz-box" style="border: 1px solid var(--border); padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fff;">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;">Cihaz ${i} DetaylarÄ±</h4>
                        <div class="form-grid">
                            ${seriHtml}
                            <div class="form-group">
                                <label>Ä°l <span class="required">*</span></label>
                                <select name="cihaz_${i}_il" id="cihaz_${i}_il" class="cihaz-il" required onchange="updateCihazIlce(${i}, this.value)">
                                    <option value="">Ä°l SeÃ§iniz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ä°lÃ§e <span class="required">*</span></label>
                                <select name="cihaz_${i}_ilce" id="cihaz_${i}_ilce" class="cihaz-ilce" required disabled>
                                    <option value="">Ã–nce Ä°l SeÃ§iniz</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>KullanÄ±m AÃ§Ä±k Adresi <span class="required">*</span></label>
                                <textarea name="cihaz_${i}_adres" class="cihaz-adres" required rows="2" placeholder="CihazÄ±n nerede kullanÄ±lacaÄŸÄ±"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Ä°lleri doldur
            if (typeof IL_ILCE !== 'undefined') {
                const iller = Object.keys(IL_ILCE).sort((a, b) => a.localeCompare(b, 'tr'));
                const selects = document.querySelectorAll('.cihaz-il');
                selects.forEach(select => {
                    iller.forEach(il => { select.add(new Option(il, il)); });
                });
            }
        }

        function updateCihazIlce(index, secilenIl) {
            const ilceSelect = document.getElementById(`cihaz_${index}_ilce`);
            ilceSelect.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz</option>';
            if (secilenIl && IL_ILCE[secilenIl]) {
                IL_ILCE[secilenIl].forEach(ilce => {
                    ilceSelect.add(new Option(ilce, ilce));
                });
                ilceSelect.disabled = false;
            } else {
                ilceSelect.innerHTML = '<option value="">Ã–nce Ä°l SeÃ§iniz</option>';
                ilceSelect.disabled = true;
            }
        }

        function copyAddressFromStep1(checkbox) {
            const merkezIl = document.getElementById('ilSelect').value;
            const merkezIlce = document.getElementById('ilceSelect').value;
            const merkezAdres = document.querySelector('textarea[name="adres"]').value;

            const adet = parseInt(document.getElementById('pos_adedi').value) || 0;

            for (let i = 1; i <= adet; i++) {
                const ilEl = document.getElementById(`cihaz_${i}_il`);
                const ilceEl = document.getElementById(`cihaz_${i}_ilce`);
                const adresEl = document.querySelector(`textarea[name="cihaz_${i}_adres"]`);

                if (checkbox.checked) {
                    ilEl.value = merkezIl;
                    updateCihazIlce(i, merkezIl);
                    setTimeout(() => { ilceEl.value = merkezIlce; }, 50); // wait for options to render
                    adresEl.value = merkezAdres;

                    // lock
                    ilEl.style.backgroundColor = '#f3f4f6'; ilEl.style.pointerEvents = 'none';
                    ilceEl.style.backgroundColor = '#f3f4f6'; ilceEl.style.pointerEvents = 'none';
                    adresEl.setAttribute('readonly', true); adresEl.style.backgroundColor = '#f3f4f6';
                } else {
                    // unlock
                    ilEl.style.backgroundColor = ''; ilEl.style.pointerEvents = 'auto';
                    ilceEl.style.backgroundColor = ''; ilceEl.style.pointerEvents = 'auto';
                    adresEl.removeAttribute('readonly'); adresEl.style.backgroundColor = '';
                }
            }
        }

        function copyFirstDeviceAddressToAll(checkbox) {
            if (!checkbox.checked) return; // Only process on check

            const adet = parseInt(document.getElementById('pos_adedi').value) || 0;
            if (adet <= 1) return;

            const ilkIl = document.getElementById('cihaz_1_il').value;
            const ilkIlce = document.getElementById('cihaz_1_ilce').value;
            const ilkAdres = document.querySelector('textarea[name="cihaz_1_adres"]').value;

            for (let i = 2; i <= adet; i++) {
                const ilEl = document.getElementById(`cihaz_${i}_il`);
                const ilceEl = document.getElementById(`cihaz_${i}_ilce`);
                const adresEl = document.querySelector(`textarea[name="cihaz_${i}_adres"]`);

                ilEl.value = ilkIl;
                updateCihazIlce(i, ilkIl);
                setTimeout(() => { ilceEl.value = ilkIlce; }, 50);
                adresEl.value = ilkAdres;
            }
            alert("1. CihazÄ±n adresi diÄŸer cihazlara baÅŸarÄ±yla kopyalandÄ±!");
        }

        function initSehirler() {
            const ilSelect = document.getElementById('ilSelect');
            const ilceSelect = document.getElementById('ilceSelect');

            if (typeof IL_ILCE !== 'undefined') {
                const iller = Object.keys(IL_ILCE).sort((a, b) => a.localeCompare(b, 'tr'));
                iller.forEach(il => {
                    ilSelect.add(new Option(il, il));
                });

                ilSelect.addEventListener('change', function () {
                    const secilenIl = this.value;
                    ilceSelect.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz</option>';
                    if (secilenIl && IL_ILCE[secilenIl]) {
                        IL_ILCE[secilenIl].forEach(ilce => {
                            ilceSelect.add(new Option(ilce, ilce));
                        });
                        ilceSelect.disabled = false;
                    } else {
                        ilceSelect.innerHTML = '<option value="">Ã–nce Ä°l SeÃ§iniz</option>';
                        ilceSelect.disabled = true;
                    }
                });
            }
        }

        function renderFileGrid() {
            const grid = document.getElementById('fileGrid');
            belgeler.forEach(b => {
                const reqHTML = b.required ? '<span class="required">*</span>' : '';
                grid.innerHTML += `
                    <div class="file-card" id="card_${b.id}">
                        <h4>${b.mask} ${reqHTML}</h4>
                        <div class="desc">${b.desc}</div>
                        <input type="file" id="file_${b.id}" name="${b.id}" class="file-input" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFile(this, '${b.id}')" ${b.required ? 'required' : ''}>
                        <label for="file_${b.id}" class="file-btn">Dosya SeÃ§</label>
                        <span class="file-name" id="name_${b.id}">YÃ¼klenmedi</span>
                    </div>
                `;
            });
        }

        function handleFile(input, id) {
            const card = document.getElementById('card_' + id);
            const nameEl = document.getElementById('name_' + id);

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 15 * 1024 * 1024) {
                    alert('Dosya boyutu 15MB dan bÃ¼yÃ¼k olamaz.');
                    input.value = '';
                    return;
                }
                card.classList.add('has-file');
                nameEl.innerText = file.name;
                nameEl.style.color = 'var(--secondary)';
                filesData[id] = file;
            } else {
                card.classList.remove('has-file');
                nameEl.innerText = 'YÃ¼klenmedi';
                nameEl.style.color = 'var(--primary)';
                delete filesData[id];
            }
            checkSubmitStatus();
        }

        function showTab(n) {
            const contents = document.getElementsByClassName("step-content");
            const btnPrev = document.getElementById("prevBtn");
            const btnNext = document.getElementById("nextBtn");
            const btnSubmit = document.getElementById("submitBtn");

            for (let i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            if (contents[n]) contents[n].classList.add('active');

            // Stepper update
            if (n < 4) {
                const steps = document.getElementsByClassName("step");
                for (let i = 0; i < steps.length; i++) {
                    steps[i].classList.remove("active", "completed");
                    if (i < n) steps[i].classList.add("completed");
                    if (i === n) steps[i].classList.add("active");
                }
            }

            if (n === 0) {
                btnPrev.classList.add("hidden");
            } else {
                btnPrev.classList.remove("hidden");
            }

            if (n === 3) { // 4th step
                btnNext.classList.add("hidden");
                btnSubmit.classList.remove("hidden");
                checkSubmitStatus();
            } else if (n === 4) { // Success step
                document.getElementById('btnGroup').style.display = 'none';
                document.querySelector('.stepper').style.display = 'none';
            } else {
                btnNext.classList.remove("hidden");
                btnSubmit.classList.add("hidden");
            }
        }

        function validateForm() {
            const n = currentTab;
            const content = document.getElementsByClassName("step-content")[n];
            const inputs = content.querySelectorAll("input, select, textarea");

            let valid = true;
            let firstInvalid = null;

            for (let i = 0; i < inputs.length; i++) {
                if (!inputs[i].checkValidity()) {
                    inputs[i].classList.add('invalid');
                    inputs[i].style.borderColor = 'var(--error)';
                    valid = false;
                    if (!firstInvalid) firstInvalid = inputs[i];
                } else {
                    inputs[i].classList.remove('invalid');
                    inputs[i].style.borderColor = 'var(--border)';
                }
            }

            if (firstInvalid) {
                firstInvalid.reportValidity();
            }

            return valid;
        }

        function nextPrev(n) {
            if (n == 1 && !validateForm()) return false;
            currentTab += n;
            showTab(currentTab);
        }

        function checkSubmitStatus() {
            const btnSubmit = document.getElementById("submitBtn");
            const kvkk = document.getElementById("kvkk").checked;
            const onay = document.getElementById("onay").checked;

            let filesValid = true;
            belgeler.forEach(b => {
                if (b.required && !filesData[b.id]) filesValid = false;
            });

            if (filesValid && kvkk && onay) {
                btnSubmit.disabled = false;
                btnSubmit.innerText = "BaÅŸvuruyu GÃ¶nder";
            } else {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Zorunlu AlanlarÄ± TamamlayÄ±n";
            }
        }

        document.getElementById("kvkk").addEventListener('change', checkSubmitStatus);
        document.getElementById("onay").addEventListener('change', checkSubmitStatus);

        async function submitForm() {
            const btn = document.getElementById("submitBtn");
            btn.innerHTML = '<span style="animation: pulse 1s infinite;">GÃ¶nderiliyor...</span>';
            btn.disabled = true;

            const form = document.getElementById('posForm');
            const data = new FormData(form);

            // Clean up aylik_ciro (remove formatting commas before sending)
            if (data.has('aylik_ciro')) {
                data.set('aylik_ciro', data.get('aylik_ciro').replace(/,/g, ''));
            }

            // Clean up files we track manually just in case
            belgeler.forEach(b => {
                data.delete(b.id);
                if (filesData[b.id]) data.append(b.id, filesData[b.id]);
            });

            // --- Collect Dynamic Device Details ---
            const cihazMulti = document.getElementById('cihaz_mulkiyeti').value;
            const posAdedi = parseInt(document.getElementById('pos_adedi').value) || 0;
            let cihazDetaylariArray = [];

            if (posAdedi > 0 && cihazMulti) {
                for (let i = 1; i <= posAdedi; i++) {
                    let cihazObj = { index: i };
                    const seriEl = document.querySelector(`input[name="cihaz_${i}_seri"]`);
                    const ilEl = document.getElementById(`cihaz_${i}_il`);
                    const ilceEl = document.getElementById(`cihaz_${i}_ilce`);
                    const adresEl = document.querySelector(`textarea[name="cihaz_${i}_adres"]`);

                    if (seriEl) cihazObj.seri_no = seriEl.value;
                    if (ilEl) cihazObj.il = ilEl.value;
                    if (ilceEl) cihazObj.ilce = ilceEl.value;
                    if (adresEl) cihazObj.adres = adresEl.value;

                    cihazDetaylariArray.push(cihazObj);
                }
            }
            data.append('cihaz_detaylari', JSON.stringify({ mulkiyet: cihazMulti, cihazlar: cihazDetaylariArray }));
            // --------------------------------------

            try {
                const response = await fetch('/api/pos/basvuru', {
                    method: 'POST',
                    body: data
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('successBasvuruNo').innerText = result.basvuru_no;
                    currentTab = 4;
                    showTab(currentTab);
                } else {
                    alert('Hata: ' + result.message);
                    btn.innerText = "BaÅŸvuruyu GÃ¶nder";
                    btn.disabled = false;
                }
            } catch (e) {
                alert('BaÄŸlantÄ± hatasÄ± oluÅŸtu!');
                btn.innerText = "BaÅŸvuruyu GÃ¶nder";
                btn.disabled = false;
            }
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value) {
                // Add commas for thousands
                input.value = parseInt(value, 10).toLocaleString('en-US');
            } else {
                input.value = '';
            }
        }

        function copyBasvuruNo() {
            const textToCopy = document.getElementById('successBasvuruNo').innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert("BaÅŸvuru numarasÄ± kopyalandÄ±: " + textToCopy);
            }).catch(err => {
                console.error('Kopyalama hatasÄ±', err);
                alert("KopyalanamadÄ±, lÃ¼tfen manuel seÃ§in.");
            });
        }

        init();
    </script>
    <div style="text-align: center; font-size: 13px; color: #888; margin-bottom: 10px; padding: 0 10px;">
        Bu site bir demo uygulamasÄ±dÄ±r. Telif haklarÄ± ihlali sÃ¶z konusu deÄŸildir.<br>
        GeliÅŸtirici: Deniz Åara
    </div>
</body>

</html>