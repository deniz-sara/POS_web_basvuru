<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS BaÅŸvurusu | Firma AdÄ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="form-header">
                <img src="qnbpay-logo.webp" alt="QNB Logo"
                    style="height: 40px; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">
                <h1>Fiziki POS BaÅŸvurusu</h1>
                <p>BaÅŸvurunuzu tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± takip edin.</p>
                <div style="margin-top: 15px;">
                    <a href="sorgula.html" class="btn btn-prev"
                        style="text-decoration: none; font-size: 13px; padding: 8px 16px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        ğŸ” BaÅŸvuru Durumu Sorgula
                    </a>
                </div>
            </div>

            <!-- Stepper -->
            <div class="stepper">
                <div class="step active" id="step-1-indicator">
                    <div class="step-circle">1</div>
                    <div class="step-label">Firma Bilgileri</div>
                </div>
                <div class="step" id="step-2-indicator">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ä°letiÅŸim</div>
                </div>
                <div class="step" id="step-3-indicator">
                    <div class="step-circle">3</div>
                    <div class="step-label">POS Talep</div>
                </div>
                <div class="step" id="step-4-indicator">
                    <div class="step-circle">4</div>
                    <div class="step-label">Evrak YÃ¼kleme</div>
                </div>
            </div>

            <form id="posForm">
                <!-- STEP 1: Firma Bilgileri -->
                <div class="step-content active" id="step-1">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Firma UnvanÄ± <span class="required">*</span></label>
                            <input type="text" name="firma_unvani" required placeholder="Tam Ticari Unvan">
                        </div>
                        <div class="form-group">
                            <label>Tabela AdÄ± / Slip BaÅŸlÄ±ÄŸÄ±</label>
                            <input type="text" name="tabela_adi" maxlength="20" placeholder="Max 20 Karakter">
                        </div>
                        <div class="form-group">
                            <label>Åirket Tipi <span class="required">*</span></label>
                            <select name="sirket_tipi" required>
                                <option value="">SeÃ§iniz...</option>
                                <option value="Sahis">ÅahÄ±s</option>
                                <option value="Tuzel">TÃ¼zel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vergi No / TC Kimlik No <span class="required">*</span></label>
                            <input type="text" name="vergi_no" required maxlength="11" placeholder="10 veya 11 Haneli">
                        </div>
                        <div class="form-group">
                            <label>Vergi Dairesi <span class="required">*</span></label>
                            <input type="text" name="vergi_dairesi" required placeholder="BaÄŸlÄ± Olunan Vergi Dairesi">
                        </div>
                        <div class="form-group">
                            <label>Faaliyet AlanÄ± <span class="required">*</span></label>
                            <select name="faaliyet_alani" required>
                                <option value="">SeÃ§iniz...</option>
                                <option value="Perakende">Perakende</option>
                                <option value="Hizmet">Hizmet</option>
                                <option value="Yeme-Ä°Ã§me">Yeme-Ä°Ã§me</option>
                                <option value="E-Ticaret">E-Ticaret</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ä°l <span class="required">*</span></label>
                            <select name="il" id="ilSelect" required>
                                <option value="">Ä°l SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ä°lÃ§e <span class="required">*</span></label>
                            <select name="ilce" id="ilceSelect" required disabled>
                                <option value="">Ã–nce Ä°l SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Tam Adres <span class="required">*</span></label>
                            <textarea name="adres" required rows="3" placeholder="Firma AÃ§Ä±k Adresi"></textarea>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Ä°letiÅŸim Bilgileri -->
                <div class="step-content" id="step-2">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Yetkili AdÄ± SoyadÄ± <span class="required">*</span></label>
                            <input type="text" name="yetkili_ad_soyad" required placeholder="Ad Soyad">
                        </div>
                        <div class="form-group">
                            <label>Cep Telefonu <span class="required">*</span></label>
                            <input type="tel" name="telefon" required placeholder="05XXXXXXXXX" pattern="^0?5[0-9]{9}$"
                                title="LÃ¼tfen geÃ§erli bir telefon numarasÄ± giriniz">
                        </div>
                        <div class="form-group">
                            <label>E-posta Adresi <span class="required">*</span></label>
                            <input type="email" name="email" required placeholder="ornek@firma.com">
                        </div>
                        <div class="form-group full-width">
                            <label>Alternatif Telefon</label>
                            <input type="tel" name="alt_telefon" placeholder="Ä°steÄŸe BaÄŸlÄ±">
                        </div>
                    </div>
                </div>

                <!-- STEP 3: POS Talep -->
                <div class="step-content" id="step-3">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Talep Edilen POS Adedi <span class="required">*</span></label>
                            <input type="number" name="pos_adedi" required min="1" max="50" value="1">
                        </div>
                        <div class="form-group">
                            <label>POS Tipi <span class="required">*</span></label>
                            <select name="pos_tipi" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="MasaÃ¼stÃ¼">MasaÃ¼stÃ¼ (Kablolu)</option>
                                <option value="Mobil">Mobil (Seyyar)</option>
                                <option value="Yazarkasa">Yazarkasa POS / Ã–KC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tahmini AylÄ±k Ciro (TL) <span class="required">*</span></label>
                            <input type="number" name="aylik_ciro" required min="1000" placeholder="100000">
                        </div>
                        <div class="form-group">
                            <label>Ortalama Ä°ÅŸlem TutarÄ± (TL) <span class="required">*</span></label>
                            <input type="number" name="ort_islem_tutari" required min="10" placeholder="500">
                        </div>
                    </div>
                </div>

                <!-- STEP 4: Evraklar -->
                <div class="step-content" id="step-4">
                    <p style="margin-bottom: 20px; color: var(--text-light); font-size: 14px;">
                        LÃ¼tfen baÅŸvuru iÃ§in gerekli evraklarÄ± PDF, JPG veya PNG formatÄ±nda (Maks 15MB) yÃ¼kleyiniz.
                        Zorunlu evraklarÄ± yÃ¼klemeden baÅŸvuruyu tamamlayamazsÄ±nÄ±z.
                    </p>

                    <div class="file-upload-grid" id="fileGrid">
                        <!-- JS TarafÄ±ndan Doldurulacak -->
                    </div>

                    <div style="margin-top: 30px;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="kvkk" required>
                            <label for="kvkk">KVKK AydÄ±nlatma Metni'ni okudum ve kabul ediyorum. <span
                                    class="required">*</span></label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="onay" required>
                            <label for="onay">VerdiÄŸim bilgilerin doÄŸruluÄŸunu ve baÅŸvuru koÅŸullarÄ±nÄ± kabul ediyorum.
                                <span class="required">*</span></label>
                        </div>
                    </div>
                </div>

                <!-- Success Screen -->
                <div class="step-content success-state" id="step-5">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                    </svg>
                    <h2>BaÅŸvurunuz AlÄ±ndÄ±!</h2>
                    <p>Referans NumaranÄ±z: <strong id="successBasvuruNo">---</strong></p>
                    <p style="font-size: 14px; color: var(--text-light);">BaÅŸvurunuz alÄ±nmÄ±ÅŸ olup deÄŸerlendirme sÃ¼recine
                        geÃ§ilmiÅŸtir. Durumu takip etmeniz iÃ§in detaylar e-posta ve SMS olarak gÃ¶nderilmiÅŸtir.</p>
                    <div style="margin-top: 30px;">
                        <a href="/pos/sorgula.html" id="trackLink" class="btn btn-next">BaÅŸvuru Durumu Sorgula</a>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="btn-group" id="btnGroup">
                    <button type="button" class="btn btn-prev hidden" id="prevBtn" onclick="nextPrev(-1)">Geri</button>
                    <div style="flex:1"></div>
                    <button type="button" class="btn btn-next" id="nextBtn" onclick="nextPrev(1)">Ä°leri</button>
                    <button type="button" class="btn btn-submit hidden" id="submitBtn" onclick="submitForm()">BaÅŸvuruyu
                        GÃ¶nder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="iller.js"></script>
    <script>
        const belgeler = [
            { id: 'ticari_sicil', mask: 'Ticari Sicil Gazetesi', required: true, desc: 'GÃ¼ncel tarihli' },
            { id: 'imza_sirkuleri', mask: 'Ä°mza SirkÃ¼leri', required: true, desc: 'Noter onaylÄ±' },
            { id: 'vergi_levhasi', mask: 'Vergi LevhasÄ±', required: true, desc: 'Son yÄ±la ait' },
            { id: 'kimlik_fotokopisi', mask: 'Kimlik Fotokopisi', required: true, desc: 'Yetkilinin Ã¶n yÃ¼zÃ¼' },
            { id: 'ikametgah', mask: 'Ä°kametgah Belgesi', required: true, desc: 'E-Devlet Ã¼zerinden' },
            { id: 'faaliyet_belgesi', mask: 'Faaliyet Belgesi', required: true, desc: 'Oda kayÄ±t belgesi' },
            { id: 'gmu_muafiyet', mask: 'GMU ve Muafiyet Belgesi', required: false, desc: 'Ä°steÄŸe baÄŸlÄ±' },
            { id: 'kira_tapu', mask: 'QNBpay SÃ¶zleÅŸme', required: false, desc: 'Ä°steÄŸe baÄŸlÄ±' },
            { id: 'banka_hesabi', mask: 'Banka Hesap CÃ¼zdanÄ±', required: false, desc: 'Ä°steÄŸe baÄŸlÄ±' }
        ];

        let currentTab = 0;
        let filesData = {};

        function init() {
            renderFileGrid();
            initSehirler();
            showTab(currentTab);
        }

        function initSehirler() {
            const ilSelect = document.getElementById('ilSelect');
            const ilceSelect = document.getElementById('ilceSelect');

            if (typeof IL_ILCE !== 'undefined') {
                const iller = Object.keys(IL_ILCE).sort((a, b) => a.localeCompare(b, 'tr'));
                iller.forEach(il => {
                    ilSelect.add(new Option(il, il));
                });

                ilSelect.addEventListener('change', function () {
                    const secilenIl = this.value;
                    ilceSelect.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz</option>';
                    if (secilenIl && IL_ILCE[secilenIl]) {
                        IL_ILCE[secilenIl].forEach(ilce => {
                            ilceSelect.add(new Option(ilce, ilce));
                        });
                        ilceSelect.disabled = false;
                    } else {
                        ilceSelect.innerHTML = '<option value="">Ã–nce Ä°l SeÃ§iniz</option>';
                        ilceSelect.disabled = true;
                    }
                });
            }
        }

        function renderFileGrid() {
            const grid = document.getElementById('fileGrid');
            belgeler.forEach(b => {
                const reqHTML = b.required ? '<span class="required">*</span>' : '';
                grid.innerHTML += `
                    <div class="file-card" id="card_${b.id}">
                        <h4>${b.mask} ${reqHTML}</h4>
                        <div class="desc">${b.desc}</div>
                        <input type="file" id="file_${b.id}" name="${b.id}" class="file-input" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFile(this, '${b.id}')" ${b.required ? 'required' : ''}>
                        <label for="file_${b.id}" class="file-btn">Dosya SeÃ§</label>
                        <span class="file-name" id="name_${b.id}">YÃ¼klenmedi</span>
                    </div>
                `;
            });
        }

        function handleFile(input, id) {
            const card = document.getElementById('card_' + id);
            const nameEl = document.getElementById('name_' + id);

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 15 * 1024 * 1024) {
                    alert('Dosya boyutu 15MB dan bÃ¼yÃ¼k olamaz.');
                    input.value = '';
                    return;
                }
                card.classList.add('has-file');
                nameEl.innerText = file.name;
                nameEl.style.color = 'var(--secondary)';
                filesData[id] = file;
            } else {
                card.classList.remove('has-file');
                nameEl.innerText = 'YÃ¼klenmedi';
                nameEl.style.color = 'var(--primary)';
                delete filesData[id];
            }
            checkSubmitStatus();
        }

        function showTab(n) {
            const contents = document.getElementsByClassName("step-content");
            const btnPrev = document.getElementById("prevBtn");
            const btnNext = document.getElementById("nextBtn");
            const btnSubmit = document.getElementById("submitBtn");

            for (let i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            if (contents[n]) contents[n].classList.add('active');

            // Stepper update
            if (n < 4) {
                const steps = document.getElementsByClassName("step");
                for (let i = 0; i < steps.length; i++) {
                    steps[i].classList.remove("active", "completed");
                    if (i < n) steps[i].classList.add("completed");
                    if (i === n) steps[i].classList.add("active");
                }
            }

            if (n === 0) {
                btnPrev.classList.add("hidden");
            } else {
                btnPrev.classList.remove("hidden");
            }

            if (n === 3) { // 4th step
                btnNext.classList.add("hidden");
                btnSubmit.classList.remove("hidden");
                checkSubmitStatus();
            } else if (n === 4) { // Success step
                document.getElementById('btnGroup').style.display = 'none';
                document.querySelector('.stepper').style.display = 'none';
            } else {
                btnNext.classList.remove("hidden");
                btnSubmit.classList.add("hidden");
            }
        }

        function validateForm() {
            const n = currentTab;
            const content = document.getElementsByClassName("step-content")[n];
            const inputs = content.querySelectorAll("input[required], select[required], textarea[required]");

            let valid = true;
            for (let i = 0; i < inputs.length; i++) {
                if (!inputs[i].value) {
                    inputs[i].classList.add('invalid');
                    inputs[i].style.borderColor = 'var(--error)';
                    valid = false;
                } else {
                    inputs[i].style.borderColor = 'var(--border)';
                }
            }
            return valid;
        }

        function nextPrev(n) {
            if (n == 1 && !validateForm()) return false;
            currentTab += n;
            showTab(currentTab);
        }

        function checkSubmitStatus() {
            const btnSubmit = document.getElementById("submitBtn");
            const kvkk = document.getElementById("kvkk").checked;
            const onay = document.getElementById("onay").checked;

            let filesValid = true;
            belgeler.forEach(b => {
                if (b.required && !filesData[b.id]) filesValid = false;
            });

            if (filesValid && kvkk && onay) {
                btnSubmit.disabled = false;
                btnSubmit.innerText = "BaÅŸvuruyu GÃ¶nder";
            } else {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Zorunlu AlanlarÄ± TamamlayÄ±n";
            }
        }

        document.getElementById("kvkk").addEventListener('change', checkSubmitStatus);
        document.getElementById("onay").addEventListener('change', checkSubmitStatus);

        async function submitForm() {
            const btn = document.getElementById("submitBtn");
            btn.innerHTML = '<span style="animation: pulse 1s infinite;">GÃ¶nderiliyor...</span>';
            btn.disabled = true;

            const form = document.getElementById('posForm');
            const data = new FormData(form);

            // Clean up files we track manually just in case
            belgeler.forEach(b => {
                data.delete(b.id);
                if (filesData[b.id]) data.append(b.id, filesData[b.id]);
            });

            try {
                const response = await fetch('/api/pos/basvuru', {
                    method: 'POST',
                    body: data
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('successBasvuruNo').innerText = result.basvuru_no;
                    // document.getElementById('trackLink').href = '/pos/durum.html?token=' + result.token; // Changed to static link below
                    currentTab = 4;
                    showTab(currentTab);
                } else {
                    alert('Hata: ' + result.message);
                    btn.innerText = "BaÅŸvuruyu GÃ¶nder";
                    btn.disabled = false;
                }
            } catch (e) {
                alert('BaÄŸlantÄ± hatasÄ± oluÅŸtu!');
                btn.innerText = "BaÅŸvuruyu GÃ¶nder";
                btn.disabled = false;
            }
        }

        init();
    </script>
    <div style="text-align: center; font-size: 13px; color: #888; margin-bottom: 10px; padding: 0 10px;">
        Bu site bir demo uygulamasÄ±dÄ±r. Telif haklarÄ± ihlali sÃ¶z konusu deÄŸildir.<br>
        GeliÅŸtirici: Deniz Åara
    </div>
</body>

</html>