<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netim Paneli | Fiziki POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #001b59;
            --secondary: #904999;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text: #1F2937;
            --border: #E5E7EB;
            --error: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-menu {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            display: block;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: 0.2s;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--secondary);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .logout-btn {
            color: #fca5a5;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--surface);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-bottom: 1px solid var(--border);
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }

        .stat-card .title {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 10px;
            color: var(--text);
        }

        /* Filters */
        .filters {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
        }

        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            outline: none;
            height: 38px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 13px;
            min-width: 140px;
        }

        .btn {
            padding: 9px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-primary:hover {
            background: #283593;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Table */
        .table-container {
            background: var(--surface);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: #f9fafb;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f9fafb;
            cursor: pointer;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.alingi {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge.inceleme {
            background: #fef3c7;
            color: #b45309;
        }

        .badge.degerlendirme {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.ek_bilgi {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.onaylandi {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.reddedildi {
            background: #f3f4f6;
            color: #374151;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal {
            background: var(--surface);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #6b7280;
            border: none;
            background: none;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: 1fr;
            }
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h4 {
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-group {
            margin-bottom: 15px;
        }

        .info-label {
            font-size: 12px;
            color: #6b7280;
            display: block;
            margin-bottom: 4px;
        }

        .info-val {
            font-size: 14px;
            font-weight: 500;
        }

        .doc-list {
            list-style: none;
        }

        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .doc-item.eksik {
            border-color: var(--error);
            background: #fef2f2;
        }

        .doc-link {
            color: var(--info);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .action-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        /* Mobile Responsive for Admin Panel */
        .preview-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .preview-modal {
            background: #fff;
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .preview-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            font-weight: 600;
            color: #111;
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #e5e7eb;
            position: relative;
        }

        .preview-content iframe,
        .preview-content img {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                overflow: auto;
            }

            .sidebar {
                width: 100%;
                flex: none;
            }

            .sidebar-header {
                padding: 15px;
            }

            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }

            .nav-item {
                white-space: nowrap;
                border-left: none;
                border-bottom: 4px solid transparent;
            }

            .nav-item.active {
                border-left: none;
                border-bottom: 4px solid var(--secondary);
            }

            .main {
                height: 100vh;
                /* Allow some scrolling inside main, or set to auto depending on preference */
                /* But since body is auto, let's just make main let it flow */
                overflow: visible;
                display: block;
            }

            .header {
                padding: 10px 15px;
            }

            .content {
                padding: 15px;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 15px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header" style="display:flex; flex-direction:column; align-items:center; gap:10px;">
            <img src="../qnbpay-logo.webp" alt="QNB Logo" style="height: 30px; margin-bottom: 5px;">
            <span style="font-size: 16px;">POS YÃ¶netimi</span>
        </div>
        <div class="nav-menu">
            <a class="nav-item active" id="nav-basvuru" onclick="showView('basvuru')">TÃ¼m BaÅŸvurular</a>
            <a class="nav-item" id="nav-kullanici" onclick="showView('kullanici')">YÃ¶neticiler</a>
            <a class="nav-item" id="nav-logs" onclick="showView('logs')">Ä°ÅŸlem GeÃ§miÅŸi</a>
        </div>
        <div class="sidebar-footer">
            <div id="adminName">Admin User</div>
            <a class="logout-btn" onclick="logout()">GÃ¼venli Ã‡Ä±kÄ±ÅŸ</a>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <h2 id="pageTitle" style="font-size: 18px; font-weight: 600;">BaÅŸvurular</h2>
            <button class="btn btn-secondary" id="btnExport" onclick="exportData()">Excel Ä°ndir</button>
        </div>
        <div class="content">

            <!-- BaÅŸvurular GÃ¶rÃ¼nÃ¼mÃ¼ -->
            <div id="view-basvuru">
                <div class="stats-grid" id="statsGrid">
                    <!-- Data from API -->
                </div>

                <div class="filters">
                    <div class="form-group">
                        <label>BaÅŸvuru No</label>
                        <input type="text" id="f_no" placeholder="Ã–rn: POS-2024...">
                    </div>
                    <div class="form-group">
                        <label>Firma AdÄ±</label>
                        <input type="text" id="f_firma" placeholder="Kelime ara">
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="f_durum">
                            <option value="">TÃ¼mÃ¼</option>
                            <option value="alingi">BaÅŸvuru AlÄ±ndÄ±</option>
                            <option value="inceleme">Evrak Ä°nceleme</option>
                            <option value="ek_bilgi">Evrak Bekleniyor</option>
                            <option value="degerlendirme">DeÄŸerlendirme</option>
                            <option value="onaylandi">OnaylandÄ±</option>
                            <option value="reddedildi">Reddedildi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tarih BaÅŸlangÄ±Ã§</label>
                        <input type="date" id="f_tarih_baslangic">
                    </div>
                    <div class="form-group">
                        <label>Tarih BitiÅŸ</label>
                        <input type="date" id="f_tarih_bitis">
                    </div>
                    <div class="form-group">
                        <label>Ä°l</label>
                        <select id="f_il">
                            <option value="">TÃ¼mÃ¼</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadBasvurular()">Filtrele</button>
                    <button class="btn btn-outline" onclick="clearFilters()">Temizle</button>
                </div>

                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>BaÅŸvuru No</th>
                                <th>Firma UnvanÄ±</th>
                                <th>Ä°l</th>
                                <th>Talep</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- KullanÄ±cÄ±lar GÃ¶rÃ¼nÃ¼mÃ¼ -->
            <div id="view-kullanici" style="display: none;">
                <div class="filters" style="justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #666;">Sisteme giriÅŸ yapabilen yÃ¶netici hesaplarÄ±.</div>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Yeni YÃ¶netici Ekle</button>
                </div>

                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Ad Soyad</th>
                                <th>Email</th>
                                <th>Son GiriÅŸ</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Data inserted here -->
                        </tbody>
                    </table>
                </div>
            </div> <!-- Ä°ÅŸlem LoglarÄ± GÃ¶rÃ¼nÃ¼mÃ¼ -->
            <div id="view-logs" style="display: none;">
                <div class="filters" style="justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #666;">Sistemdeki Ã¶nemli yÃ¶netici iÅŸlemlerinin geÃ§miÅŸi.</div>
                    <button class="btn btn-outline" onclick="loadLogs()">Yenile</button>
                </div>

                <div class="table-container">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>YÃ¶netici</th>
                                <th>Ä°ÅŸlem Tipi</th>
                                <th>BaÅŸvuru No</th>
                                <th>Detay</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Data inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>BaÅŸvuru DetayÄ±: <span id="m_basvuru_no" style="color:var(--primary)"></span></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-left">
                    <div class="detail-section">
                        <h4>Firma Bilgileri</h4>
                        <div class="grid-2">
                            <div class="info-group"><span class="info-label">Unvan</span><span class="info-val"
                                    id="m_firma"></span></div>
                            <div class="info-group"><span class="info-label">TC Kimlik No</span><span class="info-val"
                                    id="m_tcno"></span></div>
                            <div class="info-group"><span class="info-label">Vergi No</span><span class="info-val"
                                    id="m_vno"></span></div>
                            <div class="info-group"><span class="info-label">Vergi Dairesi</span><span class="info-val"
                                    id="m_vd"></span></div>
                            <div class="info-group"><span class="info-label">Faaliyet AlanÄ±</span><span class="info-val"
                                    id="m_faaliyet"></span></div>
                            <div class="info-group"><span class="info-label">Ä°l / Ä°lÃ§e</span><span class="info-val"
                                    id="m_il"></span></div>
                            <div class="info-group" style="grid-column: 1/-1"><span class="info-label">Adres</span><span
                                    class="info-val" id="m_adres"></span></div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Ä°letiÅŸim & POS Talebi</h4>
                        <div class="grid-2">
                            <div class="info-group"><span class="info-label">Yetkili</span><span class="info-val"
                                    id="m_yetkili"></span></div>
                            <div class="info-group"><span class="info-label">Telefon</span><span class="info-val"
                                    id="m_tel"></span></div>
                            <div class="info-group"><span class="info-label">Email</span><span class="info-val"
                                    id="m_email"></span></div>
                            <div class="info-group"><span class="info-label">Tahmini Ciro</span><span class="info-val"
                                    id="m_hacim"></span></div>
                            <div class="info-group"><span class="info-label">POS Ä°steÄŸi</span><span class="info-val"
                                    id="m_pos"></span></div>
                        </div>
                    </div>

                    <div class="detail-section" id="m_cihaz_section" style="display:none;">
                        <h4>Cihaz DetaylarÄ± <span id="m_cihaz_mulkiyet_badge"
                                style="font-size:11px; padding:3px 8px; background:#ede9fe; color:#4c1d95; border-radius:4px; margin-left:10px; font-weight:normal; vertical-align:middle;"></span>
                        </h4>
                        <div id="m_cihaz_list"
                            style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;"></div>
                    </div>

                    <div class="detail-section">
                        <h4>YÃ¼klenen Belgeler</h4>
                        <ul class="doc-list" id="m_docs"></ul>
                    </div>
                </div>

                <div class="modal-right">
                    <div class="action-box">
                        <h4 style="margin-bottom:15px;color:var(--text)">Durum GÃ¼ncelle</h4>
                        <select id="m_durum_select"
                            style="width:100%;padding:8px;margin-bottom:10px;border-radius:4px;border:1px solid #ccc">
                            <option value="alingi">BaÅŸvuru AlÄ±ndÄ±</option>
                            <option value="inceleme">Evrak Ä°nceleme</option>
                            <option value="degerlendirme">DeÄŸerlendirme</option>
                            <option value="onaylandi">OnaylandÄ±</option>
                            <option value="reddedildi">Reddedildi</option>
                        </select>
                        <textarea id="m_durum_not" placeholder="MÃ¼ÅŸteriye gidecek aÃ§Ä±klama (Opsiyonel)"
                            style="width:100%;padding:8px;margin-bottom:10px;border-radius:4px;border:1px solid #ccc;resize:vertical;"
                            rows="3"></textarea>
                        <button class="btn btn-primary" style="width:100%" onclick="updateDurum()">Durumu Kaydet &
                            Bildir</button>
                    </div>

                    <div class="action-box">
                        <h4 style="margin-bottom:15px;color:var(--error)">Eksik Evrak Bildirimi</h4>
                        <p style="font-size:12px;color:#666;margin-bottom:10px;">AÅŸaÄŸÄ±dan eksik veya hatalÄ±
                            belgeleri
                            seÃ§ip mÃ¼ÅŸteriye otomatik SMS ve Email linki gÃ¶nderebilirsiniz.</p>
                        <div id="m_eksik_docs"
                            style="margin-bottom:15px;max-height:150px;overflow-y:auto;background:#fff;border:1px solid #eee;padding:10px;">
                            <!-- Checkboxes here -->
                        </div>
                        <textarea id="m_eksik_not" placeholder="Eksik evrak notu..."
                            style="width:100%;padding:8px;margin-bottom:10px;border-radius:4px;border:1px solid #ccc;resize:vertical;"
                            rows="2"></textarea>
                        <button class="btn" style="width:100%;background:var(--error);color:white"
                            onclick="sendEksikEvrak()">Eksik Evrak Linki GÃ¶nder</button>
                    </div>

                    <div class="action-box">
                        <h4 style="margin-bottom:15px;">Ä°Ã§ Notlar</h4>
                        <div id="m_notlar"
                            style="max-height:150px;overflow-y:auto;font-size:12px;margin-bottom:10px;padding:10px;background:#fff;border:1px solid #eee;">
                        </div>
                        <input type="text" id="m_new_not" placeholder="Not yazÄ±n..."
                            style="width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:4px;">
                        <button class="btn btn-outline" style="width:100%" onclick="addNot()">Not Ekle (Sadece Admin
                            GÃ¶rebilir)</button>
                    </div>

                    <div class="action-box" style="margin-top:20px; border:1px solid var(--error);">
                        <h4 style="margin-bottom:10px; color:var(--error);">KalÄ±cÄ± Ä°ÅŸlem</h4>
                        <p style="font-size:12px; color:#666; margin-bottom:15px;">Bu baÅŸvuruyu sistemden tamamen
                            silebilirsiniz. (Geri alÄ±namaz)</p>
                        <button class="btn" style="width:100%; background:var(--error); color:white"
                            onclick="deleteBasvuru()">Talebi Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Create Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="u_modal_title">Yeni YÃ¶netici Ekle</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" style="grid-template-columns: 1fr; gap: 15px;">
                <input type="hidden" id="u_edit_id">
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="u_ad" placeholder="Ã–rn: Ahmet YÄ±lmaz">
                </div>
                <div class="form-group">
                    <label>Email Adresi</label>
                    <input type="email" id="u_email" placeholder="Ã–rn: ahmet@sirket.com">
                </div>
                <div class="form-group">
                    <label>Åžifre <span id="u_pass_hint"
                            style="font-size:11px; font-weight:normal; color:#666;"></span></label>
                    <input type="password" id="u_pass" placeholder="GeÃ§ici ÅŸifre belirleyin">
                </div>
                <button class="btn btn-primary" id="u_modal_btn" style="width: 100%; margin-top: 10px;"
                    onclick="saveUser()">YÃ¶neticiyi Ekle</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('pos_admin_token');
        const userStr = localStorage.getItem('pos_admin_user');

        if (!token) {
            window.location.href = 'login.html';
        }

        const user = JSON.parse(userStr || '{}');
        document.getElementById('adminName').innerText = user.ad_soyad || 'Admin';

        let currentActiveId = null;
        let currentView = 'basvuru';

        function showView(viewId) {
            currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + viewId).classList.add('active');

            if (viewId === 'basvuru') {
                document.getElementById('view-basvuru').style.display = 'block';
                document.getElementById('view-kullanici').style.display = 'none';
                document.getElementById('view-logs').style.display = 'none';
                document.getElementById('pageTitle').innerText = 'BaÅŸvurular';
                document.getElementById('btnExport').style.display = 'inline-block';
                loadDashboard();
            } else if (viewId === 'kullanici') {
                document.getElementById('view-basvuru').style.display = 'none';
                document.getElementById('view-kullanici').style.display = 'block';
                document.getElementById('view-logs').style.display = 'none';
                document.getElementById('pageTitle').innerText = 'Sistem YÃ¶neticileri';
                document.getElementById('btnExport').style.display = 'none';
                loadUsers();
            } else if (viewId === 'logs') {
                document.getElementById('view-basvuru').style.display = 'none';
                document.getElementById('view-kullanici').style.display = 'none';
                document.getElementById('view-logs').style.display = 'block';
                document.getElementById('pageTitle').innerText = 'Ä°ÅŸlem GeÃ§miÅŸi';
                document.getElementById('btnExport').style.display = 'none';
                loadLogs();
            }
        }

        const DURUM_LABELS = {
            alingi: 'BaÅŸvuru AlÄ±ndÄ±',
            inceleme: 'Evrak Ä°nceleme',
            degerlendirme: 'DeÄŸerlendirme',
            ek_bilgi: 'Evrak Bekleniyor',
            onaylandi: 'OnaylandÄ±',
            reddedildi: 'Reddedildi'
        };

        const BELGE_TIPLERI = {
            ticari_sicil: 'Ticari Sicil Gazetesi',
            imza_sirkuleri: 'Ä°mza SirkÃ¼leri',
            vergi_levhasi: 'Vergi LevhasÄ±',
            kimlik_fotokopisi: 'Kimlik Fotokopisi (Yetkili)',
            faaliyet_belgesi: 'Faaliyet Belgesi',
            gmu_muafiyet: 'GMU ve Muafiyet Belgesi',
            kira_tapu: 'QNBpay SÃ¶zleÅŸme',
            banka_hesabi: 'Banka Hesap CÃ¼zdanÄ±'
        };

        async function apiCall(endpoint, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            if (!(options.body instanceof FormData)) {
                options.headers['Content-Type'] = 'application/json';
            }

            const res = await fetch('/api/admin' + endpoint, options);
            if (res.status === 401 || res.status === 403) {
                logout();
                return;
            }
            return res.json();
        }

        function logout() {
            localStorage.removeItem('pos_admin_token');
            localStorage.removeItem('pos_admin_user');
            window.location.href = 'login.html';
        }

        async function loadDashboard() {
            // Load stats
            const stats = await apiCall('/stats');
            if (stats && stats.success) {
                let eksikCount = 0;
                let onayCount = 0;
                stats.durumlar.forEach(d => {
                    if (d.durum === 'ek_bilgi') eksikCount += d.count;
                    if (d.durum === 'onaylandi') onayCount += d.count;
                });

                if (stats.iller && stats.iller.length > 0) {
                    const ilSelect = document.getElementById('f_il');
                    const currentVal = ilSelect.value;
                    ilSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>' +
                        stats.iller.map(il => `<option value="${il}">${il}</option>`).join('');
                    ilSelect.value = currentVal;
                }

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card"><div class="title">Toplam BaÅŸvuru</div><div class="value">${stats.toplam}</div></div>
                    <div class="stat-card" style="border-left-color: var(--secondary)"><div class="title">HenÃ¼z Ä°ÅŸleme AlÄ±nmayan</div><div class="value">${stats.durumlar.find(d => d.durum === 'alingi')?.count || 0}</div></div>
                    <div class="stat-card" style="border-left-color: var(--warning)"><div class="title">Evrak Ä°nceleme</div><div class="value">${stats.durumlar.find(d => d.durum === 'inceleme')?.count || 0}</div></div>
                    <div class="stat-card" style="border-left-color: var(--error)"><div class="title">Evrak Bekleyen</div><div class="value">${eksikCount}</div></div>
                    <div class="stat-card" style="border-left-color: var(--success)"><div class="title">Onaylanan</div><div class="value">${onayCount}</div></div>
                    <div class="stat-card" style="border-left-color: var(--info)"><div class="title">BugÃ¼n Gelen</div><div class="value">${stats.bugun}</div></div>
                `;
            }

            // Load list
            loadBasvurular();
        }

        async function loadUsers() {
            const data = await apiCall('/users');
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (data && data.success) {
                data.data.forEach(u => {
                    const isOnline = u.son_giris_tarihi && (new Date() - new Date(u.son_giris_tarihi) < 15 * 60 * 1000);
                    const girisMetni = u.son_giris_tarihi ?
                        (isOnline ? '<span style="color:var(--success);font-weight:600">ðŸŸ¢ Ã‡evrimiÃ§i</span>' : `ðŸ”´ ${new Date(u.son_giris_tarihi).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}`)
                        : '<span style="color:#999;font-size:12px">HiÃ§ girmedi</span>';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:600;">${u.ad_soyad}</td>
                        <td>${u.email}</td>
                        <td style="font-size:12px;">${girisMetni}</td>
                        <td><span class="badge ${u.aktif ? 'onaylandi' : 'reddedildi'}">${u.aktif ? 'Aktif' : 'Pasif'}</span></td>
                        <td>
                            <button class="btn btn-outline" style="padding:4px 8px; font-size:11px;" onclick="openUserModal(${u.id}, '${u.email}', '${u.ad_soyad}')">DÃ¼zenle</button>
                            <button class="btn ${u.aktif ? 'btn-outline' : 'btn-primary'}" style="padding:4px 8px; font-size:11px; margin-left:5px; border-color:var(--error); color:${u.aktif ? 'var(--error)' : 'white'}; background:${u.aktif ? 'transparent' : 'var(--error)'}" onclick="toggleUserStatus(${u.id}, ${u.aktif})">${u.aktif ? 'Pasif Yap' : 'AktifleÅŸtir'}</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function openUserModal(id = null, email = '', name = '') {
            document.getElementById('u_edit_id').value = id || '';
            document.getElementById('u_email').value = email;
            document.getElementById('u_pass').value = '';
            document.getElementById('u_ad').value = name;

            document.getElementById('u_modal_title').innerText = id ? 'YÃ¶netici DÃ¼zenle' : 'Yeni YÃ¶netici Ekle';
            document.getElementById('u_modal_btn').innerText = id ? 'DeÄŸiÅŸiklikleri Kaydet' : 'YÃ¶netici Ekle';
            document.getElementById('u_pass_hint').innerText = id ? '(DeÄŸiÅŸtirmeyecekseniz boÅŸ bÄ±rakÄ±n)' : '';

            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function saveUser() {
            const id = document.getElementById('u_edit_id').value;
            const email = document.getElementById('u_email').value;
            const password = document.getElementById('u_pass').value;
            const ad_soyad = document.getElementById('u_ad').value;

            if (!email || !ad_soyad || (!id && !password)) return alert('LÃ¼tfen zorunlu alanlarÄ± doldurun.');

            const endpoint = id ? `/user/${id}` : '/user';
            const method = id ? 'PUT' : 'POST';

            const res = await apiCall(endpoint, {
                method,
                body: JSON.stringify({ email, password, ad_soyad })
            });

            if (res.success) {
                alert(`YÃ¶netici baÅŸarÄ±yla ${id ? 'gÃ¼ncellendi' : 'eklendi'}.`);
                closeUserModal();
                loadUsers();
            } else {
                alert(res.message);
            }
        }

        async function toggleUserStatus(id, currentlyActive) {
            if (!confirm(`Bu yÃ¶neticiyi ${currentlyActive ? 'pasif' : 'aktif'} yapmak istediÄŸinize emin misiniz?`)) return;

            const res = await apiCall(`/user/${id}/status`, {
                method: 'PUT',
                body: JSON.stringify({ aktif: !currentlyActive })
            });

            if (res.success) {
                loadUsers();
            } else {
                alert(res.message);
            }
        }

        function clearFilters() {
            document.getElementById('f_no').value = '';
            document.getElementById('f_firma').value = '';
            document.getElementById('f_durum').value = '';
            document.getElementById('f_tarih_baslangic').value = '';
            document.getElementById('f_tarih_bitis').value = '';
            document.getElementById('f_il').value = '';
            loadBasvurular();
        }

        async function loadBasvurular() {
            const params = new URLSearchParams();
            if (document.getElementById('f_no').value) params.append('basvuru_no', document.getElementById('f_no').value);
            if (document.getElementById('f_firma').value) params.append('firma', document.getElementById('f_firma').value);
            if (document.getElementById('f_durum').value) params.append('durum', document.getElementById('f_durum').value);
            if (document.getElementById('f_tarih_baslangic').value) params.append('tarih_baslangic', document.getElementById('f_tarih_baslangic').value);
            if (document.getElementById('f_tarih_bitis').value) params.append('tarih_bitis', document.getElementById('f_tarih_bitis').value);
            if (document.getElementById('f_il').value) params.append('il', document.getElementById('f_il').value);

            const data = await apiCall('/basvurular?' + params.toString());
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data && data.success) {
                data.data.forEach(b => {
                    const tr = document.createElement('tr');
                    tr.onclick = () => openModal(b.id);
                    tr.innerHTML = `
                        <td>${new Date(b.basvuru_tarihi).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                        <td style="font-weight:600;color:var(--primary)">${b.basvuru_no}</td>
                        <td>${b.firma_unvani}</td>
                        <td>${b.il || '-'}</td>
                        <td>${b.pos_adedi}x ${b.pos_tipi}</td>
                        <td><span class="badge ${b.durum}">${DURUM_LABELS[b.durum] || b.durum}</span>
                            ${b.eksik_belge > 0 ? `<br><span style="font-size:11px;color:red">${b.eksik_belge} belge eksik</span>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function exportData() {
            window.open('/api/admin/export?token=' + token, '_blank');
        }

        // ================= Modal Handling =================

        async function openModal(id) {
            currentActiveId = id;
            const data = await apiCall(`/basvuru/${id}`);
            if (!data || !data.success) return alert('Veri alÄ±namadÄ±');

            const b = data.basvuru;
            document.getElementById('m_basvuru_no').innerText = b.basvuru_no;
            document.getElementById('m_firma').innerText = b.firma_unvani;
            document.getElementById('m_tcno').innerText = b.tc_no || 'Belirtilmedi';
            document.getElementById('m_vno').innerText = b.vergi_no || 'Belirtilmedi';
            document.getElementById('m_vd').innerText = b.vergi_dairesi;
            document.getElementById('m_faaliyet').innerText = b.faaliyet_alani;
            document.getElementById('m_il').innerText = `${b.il} / ${b.ilce}`;
            document.getElementById('m_adres').innerText = b.adres;

            document.getElementById('m_yetkili').innerText = b.yetkili_ad_soyad;
            document.getElementById('m_tel').innerText = b.telefon + (b.alt_telefon ? ' / ' + b.alt_telefon : '');
            document.getElementById('m_email').innerText = b.email;
            document.getElementById('m_hacim').innerText = `${Number(b.aylik_ciro).toLocaleString('tr-TR')} TL`;
            document.getElementById('m_pos').innerText = `${b.pos_adedi} Adet ${b.pos_tipi}`;

            // Cihaz DetaylarÄ± parse
            const cihazSection = document.getElementById('m_cihaz_section');
            const cihazList = document.getElementById('m_cihaz_list');
            const cihazMulkiyetBadge = document.getElementById('m_cihaz_mulkiyet_badge');

            cihazList.innerHTML = '';
            cihazSection.style.display = 'none';

            if (b.cihaz_detaylari) {
                try {
                    const parsed = JSON.parse(b.cihaz_detaylari);
                    if (parsed && parsed.cihazlar && parsed.cihazlar.length > 0) {
                        cihazSection.style.display = 'block';
                        cihazMulkiyetBadge.innerText = parsed.mulkiyet === 'Kendi Cihazim' ? 'MÃ¼ÅŸteriye Ait Cihaz' : 'QNBpay Cihaz Talebi';

                        parsed.cihazlar.forEach(c => {
                            let parts = [];
                            if (c.seri_no) parts.push(`<strong>Seri No:</strong> ${c.seri_no}`);
                            parts.push(`<strong>KullanÄ±m Adresi:</strong> ${c.adres} <span style="color:#6b7280; font-size:11px;">(${c.ilce} / ${c.il})</span>`);

                            cihazList.innerHTML += `
                                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; font-size:13px;">
                                    <div style="font-weight:600; color:var(--primary); margin-bottom:8px; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">Cihaz ${c.index}</div>
                                    <div style="color:#475569; line-height:1.5;">${parts.join('<br>')}</div>
                                </div>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Cihaz JSON parse hatasi", e);
                }
            }

            // Durum update
            const selectEl = document.getElementById('m_durum_select');
            if (selectEl.querySelector(`option[value="${b.durum}"]`)) {
                selectEl.value = b.durum;
            } else {
                selectEl.value = 'inceleme'; // Reset to reasonable default if mapped state is different
            }
            document.getElementById('m_durum_not').value = b.durum_aciklama || '';

            // Belgeler
            const docList = document.getElementById('m_docs');
            const eksikBox = document.getElementById('m_eksik_docs');
            docList.innerHTML = '';
            eksikBox.innerHTML = '';

            // Hangi belgelerin mevcut olduÄŸunu map'le
            const mevcut = {};
            data.belgeler.forEach(d => {
                mevcut[d.belge_tipi] = d;

                let fileUrl = '';
                if (d.dosya_yolu) {
                    const token = localStorage.getItem('pos_admin_token');
                    if (d.dosya_yolu.startsWith('http')) {
                        fileUrl = d.dosya_yolu;
                    } else if (d.dosya_yolu.startsWith('/')) {
                        fileUrl = `${d.dosya_yolu}?token=${token}`;
                    } else {
                        fileUrl = `/api/admin/dosya/${d.dosya_yolu.split(/[\\/]/).pop()}?token=${token}`;
                    }

                    // Cloudinary uzantÄ± eksikliÄŸi Ã§Ã¶zÃ¼mÃ¼: orijinal uzantÄ±yÄ± URL sonuna ekle
                    if (fileUrl.includes('cloudinary.com') && d.orijinal_ad) {
                        const ext = d.orijinal_ad.split('.').pop().toLowerCase();
                        if (!fileUrl.toLowerCase().endsWith('.' + ext)) {
                            fileUrl += '.' + ext;
                        }
                    }
                }

                docList.innerHTML += `
                    <li class="doc-item ${d.durum === 'eksik' ? 'eksik' : ''}">
                        <div>
                            <span style="font-size:14px;font-weight:500">${d.belge_adi}</span>
                            <div style="font-size:11px;color:#888">${d.durum === 'eksik' ? 'Eksik Ä°ÅŸaretlendi' : new Date(d.yukleme_tarihi).toLocaleString()}</div>
                        </div>
                        ${fileUrl ? `
                            <div style="display:flex; gap:8px;">
                                <a href="#" onclick="forceDownload('${fileUrl}', '${d.orijinal_ad || 'belge'}', event)" class="doc-link" style="color:var(--primary); font-weight:600; text-decoration:underline;">Ä°ndir</a>
                                <button onclick="openPreview('${fileUrl}', '${d.belge_adi}')" class="doc-link" style="background:var(--secondary); color:#fff; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">Ã–nizle</button>
                            </div>
                        ` : '<span style="color:red;font-size:12px">Bekleniyor</span>'}
                    </li>
                `;
            });

            // Eksik bildirim checkboxlarÄ± (Sadece ZORUNLU listesindeki tÃ¼m belgeler gÃ¶sterilir, yÃ¼klÃ¼ olsa bile tekrar eksik iÅŸareti verilebilsin diye)
            Object.entries(BELGE_TIPLERI).forEach(([key, val]) => {
                const isEksikState = mevcut[key] && mevcut[key].durum === 'eksik';
                eksikBox.innerHTML += `
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:13px;">
                            <input type="checkbox" name="eksik_cb" value="${key}" ${isEksikState ? 'checked' : ''} ${isEksikState ? 'disabled title="Zaten istendi"' : ''}>
                            ${val} ${!mevcut[key] ? '<span style="color:red;font-size:10px">(HiÃ§ YÃ¼klenmemiÅŸ)</span>' : ''}
                        </label>
                    `;
            });

            // Notlar
            renderNotlar(data.notlar);

            document.getElementById('detailModal').style.display = 'flex';
        }

        function renderNotlar(notlar) {
            const nHtml = notlar.map(n => `
                        < div style = "border-bottom:1px solid #efefef;padding-bottom:5px;margin-bottom:5px;" >
                    <strong style="color:var(--primary)">${n.ad_soyad}</strong> <span style="color:#aaa">(${new Date(n.olusturma_tarihi).toLocaleString('tr-TR')})</span><br>
                    ${n.not_metni}
                </div>
                    `).join('');
            document.getElementById('m_notlar').innerHTML = nHtml || 'HenÃ¼z not yok.';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentActiveId = null;
        }

        async function updateDurum() {
            if (!currentActiveId) return;
            const durum = document.getElementById('m_durum_select').value;
            const aciklama = document.getElementById('m_durum_not').value;

            if (!confirm('Durumu gÃ¼ncelleyip mÃ¼ÅŸteriye SMS/Email gÃ¶ndermek istiyor musunuz?')) return;

            const res = await apiCall(`/basvuru/${currentActiveId}/durum`, {
                method: 'PUT',
                body: JSON.stringify({ durum, aciklama })
            });

            if (res.success) {
                alert('Durum gÃ¼ncellendi ve bildirim gÃ¶nderildi.');
                loadDashboard();
            } else alert(res.message);
        }

        async function sendEksikEvrak() {
            if (!currentActiveId) return;
            const checks = document.querySelectorAll('input[name="eksik_cb"]:checked:not(:disabled)');
            const vals = Array.from(checks).map(c => c.value);

            if (vals.length === 0) return alert('LÃ¼tfen en az bir belge seÃ§in (daha Ã¶nce istenenler hariÃ§).');
            const aciklama = document.getElementById('m_eksik_not').value;

            if (!confirm('MÃ¼ÅŸteriye eksik evrak linki iÃ§eren SMS/Email gÃ¶nderilecek. OnaylÄ±yor musunuz?')) return;

            const res = await apiCall(`/basvuru/${currentActiveId}/eksik-evrak`, {
                method: 'PUT',
                body: JSON.stringify({ eksik_belgeler: vals, aciklama })
            });

            if (res.success) {
                alert('Eksik evrak bildirimi gÃ¶nderildi!');
                openModal(currentActiveId); // refresh
                loadDashboard();
            } else alert(res.message);
        }

        async function addNot() {
            if (!currentActiveId) return;
            const nInput = document.getElementById('m_new_not');
            const val = nInput.value.trim();
            if (!val) return;

            const res = await apiCall(`/basvuru/${currentActiveId}/not`, {
                method: 'POST',
                body: JSON.stringify({ not_metni: val })
            });

            if (res.success) {
                nInput.value = '';
                const data = await apiCall(`/basvuru/${currentActiveId}`);
                renderNotlar(data.notlar);
            }
        }

        // Init
        loadDashboard();

        // Preview Modal Functions
        function openPreview(url, title) {
            document.getElementById('previewTitle').innerText = title;
            const contentDiv = document.getElementById('previewContent');

            // EÄŸer PDF ise veya veritabanÄ±ndan Ã§ekilen gizli PDF verisi ise iframe ile gÃ¶ster
            if (url.toLowerCase().includes('.pdf') || url.includes('/api/admin/dosya-indir')) {
                contentDiv.innerHTML = `<iframe src="${url}"></iframe>`;
            } else {
                contentDiv.innerHTML = `<img src="${url}" alt="Ã–nizleme">`;
            }

            document.getElementById('previewOverlay').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('previewOverlay').style.display = 'none';
            document.getElementById('previewContent').innerHTML = '';
        }

        async function forceDownload(url, filename, event) {
            if (event) event.preventDefault();
            try {
                const e = event ? event.target : null;
                const oldText = e ? e.innerText : '';
                if (e) e.innerText = 'Ä°ndiriliyor...';

                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = filename;

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);

                if (e) e.innerText = oldText;
            } catch (error) {
                console.error('Download failed', error);
                window.open(url, '_blank');
            }
        }
        async function loadLogs() {
            const data = await apiCall('/logs');
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';

            if (data && data.success) {
                data.data.forEach(l => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td style="font-size:12px;color:#555">${new Date(l.tarih).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                    <td style="font-weight:600">${l.admin_ad || '-'}</td>
                    <td><span class="badge" style="background:#e5e7eb;color:#374151">${l.islem_tipi}</span></td>
                    <td style="font-weight:600;color:var(--primary)">${l.basvuru_no || '-'}</td>
                    <td style="font-size:13px;max-width:300px;white-space:normal">${l.detay || '-'}</td>
                `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function deleteBasvuru() {
            if (!currentActiveId) return;
            if (!confirm('DÄ°KKAT! Bu baÅŸvuruya ait olan tÃ¼m yÃ¼klenen dosyalar, iÃ§ notlar ve geÃ§miÅŸ kalÄ±cÄ± olarak SÄ°LÄ°NECEKTÄ°R. Bu iÅŸlemi onaylÄ±yor musunuz?')) return;

            const res = await apiCall(`/basvuru/${currentActiveId}`, { method: 'DELETE' });

            if (res.success) {
                alert('BaÅŸvuru kalÄ±cÄ± olarak silindi.');
                closeModal();
                loadBasvurular();
                if (currentView === 'logs') loadLogs();
            } else {
                alert(res.message || 'Silme baÅŸarÄ±sÄ±z');
            }
        }
    </script>

    <!-- Preview Modal Overlay -->
    <div id="previewOverlay" class="preview-modal-overlay">
        <div class="preview-modal">
            <div class="preview-header">
                <span id="previewTitle">Ã–nizleme</span>
                <button onclick="closePreview()"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="preview-content" id="previewContent"></div>
        </div>
    </div>
    <div style="position: fixed; bottom: 10px; right: 20px; font-size: 11px; color: #aaa; z-index: 1000;">Developer:
        Deniz Åžara</div>
</body>

</html>